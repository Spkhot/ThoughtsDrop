<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ThoughtDrop - View Problems</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: auto; padding: 1rem; background: #f0f4f8; }
    h1 { text-align: center; color: #333; }
    select, button, textarea, input { font-size: 1rem; padding: 0.5rem; margin: 0.3rem 0; }
    .problem { background: #fff; margin-bottom: 1rem; padding: 1rem; border-radius: 6px; box-shadow: 0 2px 5px rgb(0 0 0 / 0.1); }
    .problem-title { font-weight: bold; color: #2a2a72; }
    .problem-description { margin: 0.5rem 0; }
    .replies { margin-top: 0.5rem; padding-left: 1rem; border-left: 3px solid #2a2a72; }
    .reply { margin-bottom: 0.3rem; font-style: italic; color: #555; }
    .reply-form textarea { width: 100%; }
    .reply-form button { background: #2a2a72; color: white; border: none; cursor: pointer; }
    .reply-form button:hover { background: #1a1a50; }
  </style>
</head>
<body>

  <h1>View Problems</h1>

  <label for="categorySelect">Select Category:</label>
  <select id="categorySelect">
    <option value="relationship">Relationship</option>
    <option value="study">Study</option>
    <option value="college life">College Life</option>
    <option value="job problems">Job Problems</option>
  </select>

  <div id="problemsContainer"></div>

<script>
  const categorySelect = document.getElementById('categorySelect');
  const problemsContainer = document.getElementById('problemsContainer');

  async function fetchProblems(category) {
  problemsContainer.innerHTML = 'Loading...';
  try {
    const res = await fetch(`/api/problems/${encodeURIComponent(category)}`);
    if (!res.ok) throw new Error('Failed to fetch');
    const problems = await res.json();
    renderProblems(problems);
  } catch (e) {
    problemsContainer.innerHTML = '<p>Error loading problems.</p>';
  }
}


  function renderProblems(problems) {
    if (problems.length === 0) {
      problemsContainer.innerHTML = '<p>No problems found in this category.</p>';
      return;
    }
    problemsContainer.innerHTML = '';
    problems.forEach(problem => {
      const div = document.createElement('div');
      div.className = 'problem';

      div.innerHTML = `
        <div class="problem-title">${escapeHtml(problem.title)}</div>
        <div class="problem-description">${escapeHtml(problem.description)}</div>
        <div class="replies">
          <strong>Replies:</strong>
          <div>${problem.replies.length > 0 ? problem.replies.map(r => `<div class="reply">${escapeHtml(r)}</div>`).join('') : '<em>No replies yet.</em>'}</div>
        </div>
        <form class="reply-form" data-id="${problem._id}">
          <textarea rows="2" placeholder="Write your reply..." required></textarea>
          <button type="submit">Submit Reply</button>
        </form>
      `;

      problemsContainer.appendChild(div);

      const form = div.querySelector('.reply-form');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const replyText = form.querySelector('textarea').value.trim();
        if (!replyText) return alert('Reply cannot be empty.');

        try {
          const res = await fetch(`/api/problems/${problem._id}/reply`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reply: replyText }),
          });
          if (!res.ok) throw new Error('Failed to submit reply');
          const updatedProblem = await res.json();
          form.querySelector('textarea').value = '';
          fetchProblems(categorySelect.value);  // Refresh list
        } catch (err) {
          alert('Error submitting reply.');
        }
      });
    });
  }

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, (m) => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[m]);
  }

  categorySelect.addEventListener('change', () => {
    fetchProblems(categorySelect.value);
  });

  // Initial fetch
  fetchProblems(categorySelect.value);
</script>

</body>
</html>
