<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>View Problems | ThoughtDrop</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #121212;
      color: #f0f0f0;
      padding: 20px;
      margin: 0;
    }

    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 10px;
      color: #ffd369;
    }

    select, textarea, input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
    }

    select {
      background: #1f1f1f;
      color: #fff;
    }

    button {
      padding: 10px 20px;
      margin-top: 10px;
      background: #ffd369;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button:hover {
      background: #ffb347;
    }

    .problem-card {
      background: #1e1e1e;
      margin-top: 20px;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px #333;
      transition: transform 0.2s;
    }

    .problem-card:hover {
      transform: scale(1.01);
    }

    .reply {
      background: #2b2b2b;
      margin: 6px 0;
      padding: 10px;
      border-radius: 6px;
      font-size: 0.95rem;
      position: relative;
    }

    .delete-btn {
      margin-left: 10px;
      background: none;
      border: none;
      color: #ff9999;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .delete-btn:hover {
      color: red;
    }

    .reply-form {
      margin-top: 10px;
    }

    @media screen and (max-width: 600px) {
      h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>

  <h1>üß† View Anonymous Problems</h1>

  <label for="categorySelect">Choose Category:</label>
  <select id="categorySelect">
    <option value="relationship">Relationship</option>
    <option value="study">Study</option>
    <option value="college">College Life</option>
    <option value="job">Job</option>
    <option value="mental-health">Mental Health</option>
  </select>

  <div id="problemsContainer"></div>

  <script>
    const categorySelect = document.getElementById('categorySelect');
    const problemsContainer = document.getElementById('problemsContainer');

    const escapeHtml = (unsafe) => {
      return unsafe.replace(/[&<"'>]/g, (match) => {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return map[match];
      });
    };

    async function fetchProblems(category) {
      try {
        const res = await fetch(`/api/problems/${category}`);
        const data = await res.json();
        renderProblems(data);
      } catch (err) {
        problemsContainer.innerHTML = "<p>Error fetching problems</p>";
      }
    }

    function renderProblems(problems) {
      problemsContainer.innerHTML = "";
      problems.forEach(problem => {
        const div = document.createElement("div");
        div.className = "problem-card";

        div.innerHTML = `
          <h3>${escapeHtml(problem.title)}</h3>
          <p>${escapeHtml(problem.description)}</p>
          <h4>Replies:</h4>
          <div>
            ${
              problem.replies.length > 0
                ? problem.replies.map((r, index) => {
                    const createdAt = new Date(r.createdAt);
                    const now = new Date();
                    const timeDiff = now - createdAt;
                    const within2Minutes = timeDiff < 2 * 60 * 1000;

                    return `
                      <div class="reply">
                        ${escapeHtml(r.text)}
                        ${
                          within2Minutes
                            ? `<button class="delete-btn" data-id="${problem._id}" data-index="${index}">üóëÔ∏è Delete</button>`
                            : ""
                        }
                      </div>
                    `;
                  }).join('')
                : "<em>No replies yet.</em>"
            }
          </div>

          <form class="reply-form" data-id="${problem._id}">
            <textarea name="reply" rows="2" placeholder="Write a helpful reply..." required></textarea>
            <button type="submit">Reply</button>
          </form>
        `;

        problemsContainer.appendChild(div);

        // Handle reply submission
        const form = div.querySelector(".reply-form");
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const reply = form.reply.value.trim();
          if (!reply) return;
          try {
            await fetch(`/api/problems/${form.dataset.id}/reply`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ reply })
            });
            fetchProblems(categorySelect.value);
          } catch (err) {
            alert("Error submitting reply");
          }
        });

        // Handle delete buttons
        div.querySelectorAll(".delete-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
            const replyIndex = btn.getAttribute("data-index");
            const problemId = btn.getAttribute("data-id");

            if (!confirm("Are you sure you want to delete this reply?")) return;

            try {
              const res = await fetch(`/api/problems/${problemId}/delete-reply`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ replyIndex })
              });

              const result = await res.json();
              if (!res.ok) return alert(result.error || "Delete failed");
              fetchProblems(categorySelect.value);
            } catch (err) {
              alert("Error deleting reply");
            }
          });
        });
      });
    }

    // Initial load
    categorySelect.addEventListener("change", () => {
      fetchProblems(categorySelect.value);
    });

    fetchProblems(categorySelect.value);
  </script>

</body>
</html>
